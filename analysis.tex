\section{Analysis}

\begin{definition}[Entropic Growth]
  The \emph{Entropic Growth} property of
  a \poem execution,
  parametrized by the growth interval $s \in \mathbb{N}$
  and the growth velocity $\tau \in \mathbb{R}^+$,
  states that for
  all honest parties $P$ and all rounds $r_1 + s \leq r_2$,
  the chains $C_1, C_2$ of $P$ at rounds $r_1, r_2$ respectively
  satisfy $\work(C_2[{|C_1|}{:}]) \geq s \tau \lg T$.
\end{definition}

\begin{definition}[Entropic Quality]
  The \emph{Entropic Quality} property of
  a \poem execution, parametrized by the \emph{quality chunk parameter} $\ell \in \mathbb{N}$
  and \emph{quality concentration parameter} $\mu \in \mathbb{R}^+$
  (with $\ell \mu \geq 1$)
  states that for
  all honest parties $P$ and all rounds $r$,
  the chain $C$ of $P$ at round $r$
  has the property that
  for every $0 \leq \alpha < \work(C) - \ell \lg T$,
  there is at least one honestly generated block in the chain
  $[{\alpha}{:}{\alpha + \ell \lg T}] \lhd C$.
\end{definition}

\begin{definition}[Entropic Common Prefix]
  The \emph{Entropic Common Prefix} property of
  a \poem execution, parametrized by the \emph{common prefix parameter} $k \in \mathbb{N}$
  states that for
  all honest parties $P_1, P_2$
  and all rounds $r_1 \leq r_2$,
  the chains $C_1, C_2$ of $P_1, P_2$ at rounds $r_1, r_2$ respectively
  satisfy $[{:}{-k}] \lhd C_1 \preceq C_2$.
\end{definition}

\begin{conjecture}[Entropic Growth]
  Typical executions of \poem satisfy the Entropic Growth property
  with $s = \lambda$ and $\tau = (1 - \epsilon)f$.
\end{conjecture}

\begin{conjecture}[Entropic Quality]
  Typical executions of \poem satisfy the Entropic Quality property
  with $\ell = 2 \lambda f$ and
  $\mu = 1 - (1 + \frac{\delta}{2})\frac{t}{n - t} - \frac{\epsilon}{1 - \epsilon}$.
\end{conjecture}

\begin{conjecture}[Entropic Common Prefix]
  Typical executions of \poem satisfy the Entropic Common Prefix property
  with $k = 2 \lambda f$.
\end{conjecture}

In the analysis we are going to assume honest majority.

\begin{definition}[Honest Majority Assumption]
  We say that an execution has \emph{honest majority} with \emph{honest advantage parameter}
  $0 < \delta \leq 1$, if the number $t$ of corrupted parties out of
  $n$ parties satisfies $t \leq (1 - \delta) (n - t)$.
\end{definition}
\atnote{Add the balancing equation $3f + 3\epsilon < \delta \leq 1$ separately}


Consider an execution of the \poem protocol.

We define a random variable $X_{r, i}$ as follows.
If at round $r$, honest party $P_i$ finds a valid block $B$, then $X_{r, i} = \work(B)$.
If no valid block is found, $X_{r, i} = 0$. We define $X_{r}$ as the maximum intrinsic work
generated by an honest party during round $r$. Hence, $X_{r} = \max_{i = 1}^{n - t}{X_{r,i}}$.
If at round $r$ at least one honest party finds a valid block ($X_r > 0$),
we say that round $r$ is a \emph{successful round}.

We define a discrete random variable $Y_r$ as follows.
If at round $r$ exactly one honest party obtains a valid block, then $Y_r = \work(B)$ (where $B$
is the block), and we call $r$ a \emph{convergence opportunity}.
Otherwise, $Y_r = 0$.

We define a discrete random variable $Z_{r, j, k}$ as follows.
If at round $r$, the $k$-th query of adversarial party $P_j$ is a valid block $B$, then
$Z_{r, j, k} = \work(B)$. If no valid block is found, $Z_{r, j, k} = 0$.
We define $Z_{r}$ as the sum of all intrinsic work generated by all adversarial
party queries during round $r$. Hence, $Z_{r} = \sum_{j = 1}^{t}{ \sum_{k = 1}^{q}{ Z_{r, j, k} } }$.
\atnote{Maybe call adversarial parties $P_j^{\mathcal{A}}$}

We define a continuous uniform random variable $\tilde A \sim U((0, 2^\kappa])$ and
a continuous random variable
\begin{gather*}
  \hat A =
  \begin{cases}
    2^\kappa & \text{if } \tilde A > T = 2^\gamma \\
    \tilde A & \text{otherwise}
  \end{cases}\,.
\end{gather*}
We let $\HX_{r, i} = \kappa - \lg \hat A$. We note that $\HX_{r, i} \sim X_{r, i}$.
We calculate the Cumulative Distribution Function of $\HX_{r, i}$:

\begin{gather*}
  \cdf[\HX_{r, i}](y) = \\
  \Pr[\HX_{r, i} \leq y] = \\
  \Pr[\kappa - \lg \hat A \leq y] = \\
  \Pr[\hat A \geq 2^{\kappa - y}] = \\
  \int_{\min(2^{\kappa - y}, 2^\gamma)}^{2^\gamma}{\frac{1}{2^\kappa - 1} dx} + \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} = \\
  \begin{cases}
    \frac{1}{2^\kappa - 1}(2^\gamma - 2^{\kappa - y}) + \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} & \text{if } y \geq \kappa - \gamma \\
    \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} & \text{otherwise}
  \end{cases}
\end{gather*}

We now calculate the Probability Density Function of $\HX_{r, i}$:

\begin{gather*}
  \pdf[\HX_{r, i}](y) = \\
  \frac{d}{dy}\cdf[\HX_{r, i}](y) = \\
  \begin{cases}
    \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} \delta(y) & \text{if } 0 \leq y < \kappa - \gamma \\
    \frac{2^{\kappa - y} \ln 2}{2^\kappa - 1} & \text{if } \kappa - \gamma \leq y \leq \kappa
  \end{cases} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} \delta(y) + u(y - (\kappa - \gamma)) \frac{2^{\kappa - y} \ln 2}{2^\kappa - 1} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} \delta(y) + u(y - (\kappa - \gamma)) \frac{2^{\kappa} \ln 2}{2^\kappa - 1} e^{-y\ln2}
\end{gather*}

The function $\delta(y)$ is the Dirac delta function. The function $u(y - (\kappa - \gamma))$ is the Heaviside step function
starting from $\kappa - \gamma$.
We now calculate the expectation of $\HX_{r, i}$:

\begin{gather*}
  \E[\HX_{r, i}] = \\
  \int_{0}^{\kappa} y \pdf[\HX_{r, i}](y) dy = \\
  \int_{\kappa - \gamma}^{\kappa}{y \frac{2^{\kappa - y} \ln 2}{2^\kappa - 1} dy} = \\
  \frac{2^\kappa \ln 2}{2^\kappa - 1} \int_{\kappa - \gamma}^{\kappa}{y 2^{- y} dy} = \\
  \frac{2^\kappa}{2^\kappa - 1} (-y 2^{-y}\Big|_{\kappa - \gamma}^{\kappa} - \int_{\kappa - \gamma}^{\kappa}{-2^{- y} dy}) = \\
  \frac{2^\kappa}{2^\kappa - 1} (-y 2^{-y} - \frac{2^{-y}}{\ln 2}) \Big|_{\kappa - \gamma}^{\kappa} = \\
  \frac{-\kappa - \frac{1}{\ln2} - \gamma 2^\gamma + \kappa 2^\gamma + \frac{2^\gamma}{\ln 2}}{2^\kappa - 1} = \\
  \frac{\kappa 2^\gamma - \gamma 2^\gamma + \kappa}{2^\kappa - 1} + \frac{2^\gamma - 1}{\ln 2 (2^\kappa - 1)}
\end{gather*}

We calculate the Fourier Transform $\PDF[\HX_{r,i}]$ of $\pdf[\HX_{r,i}]$.
\begin{gather*}
  \PDF[\HX_{r,i}](y) = \\
  F\{\frac{2^\kappa - 2^\gamma}{2^\kappa - 1} \delta(y) + u(y - (\kappa - \gamma)) \frac{2^{\kappa} \ln 2}{2^\kappa - 1} e^{-y\ln2}\} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1}F\{\delta(y)\} + \frac{2^{\kappa} \ln 2}{2^\kappa - 1} F\{e^{-y\ln2} u(y - (\kappa - \gamma))\} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} + \frac{2^{\kappa} \ln 2 e^{-(\kappa - \gamma)\ln2}}{2^\kappa - 1} F\{e^{-\ln2(y - (\kappa - \gamma))} u(y - (\kappa - \gamma))\} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} + \frac{2^{\gamma} \ln 2}{2^\kappa - 1} F\{e^{-\ln2(y - (\kappa - \gamma))} u(y - (\kappa - \gamma))\} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} + \frac{2^{\gamma} \ln 2}{2^\kappa - 1} e^{-j(\kappa - \gamma)\omega} F\{e^{-\ln2y} u(y)\} = \\
  \frac{2^\kappa - 2^\gamma}{2^\kappa - 1} + \frac{2^{\gamma} \ln 2}{2^\kappa - 1} \frac{e^{-j(\kappa - \gamma)\omega}}{\ln2 + j\omega} = \\
  \frac{1}{2^\kappa - 1} (2^\kappa - 2^\gamma + 2^{\gamma} \ln 2 \frac{e^{-j(\kappa - \gamma)\omega}}{\ln2 + j\omega}) = \\
\end{gather*}

We calculate the Probability Density Function of $\sum_{i=0}^{n-t}{\HX_{r,i}} = \HX_r$.
The Convolution theorem is used:

\begin{gather*}
  \pdf[\HX_r](x) = \\
  \circledast_{i=1}^{n-t}\pdf[\HX_{r,i}](x) = \\
  F^{-1}\{\Pi_{i=1}^{n-t}\PDF[\HX_{r,i}](x)\} = \\
  F^{-1}\{(\PDF[\HX_{r,i}](x))^{n - t}\} = \\
  F^{-1}\{\Pi_{i=1}^{n-t} F\{\frac{2^\kappa - 2^\gamma}{2^\kappa - 1} \delta(y) + u(y - (\kappa - \gamma)) \frac{2^{\kappa} \ln 2}{2^\kappa - 1} e^{-y\ln2}\} \} = \\
\end{gather*}

% This random variable represents the output of a single query to the random oracle given
% a new input. We calculate a lower bound for the expectation of $\work(A)$:

% \begin{gather*}
%   \E[\work(A)] = \\
%   \E[\kappa - \lg{A}] \geq \\
%   \E[\floor*{\kappa - \lg{A}}] = \\
%   \sum_{\mu = 0}^{\kappa - 1}{(\mu 2^{-\mu - 1})} + \kappa \frac{1}{2^\kappa} \geq \\
%   \sum_{\mu = 1}^{\kappa - 1}{\mu 2^{-\mu - 1}} \geq \\
%   \int_{1}^{\kappa - 1}{(\mu + 1) 2^{-\mu - 2} \, d\mu} = \\
%   \int_{1}^{\kappa - 1}{\mu 2^{-\mu - 2} \, d\mu} + \int_{1}^{\kappa - 1}{2^{-\mu - 2} \, d\mu} = \\
%   - \frac{2^{-\mu - 2}}{\ln2} (\mu + \frac{1}{\ln2}) \Big|_{1}^{\kappa - 1} - \frac{2^{-\mu - 2}}{\ln2} \Big|_{1}^{\kappa - 1} = \\
%   - \frac{2^{-\mu - 2}}{\ln2} (\mu + \frac{1}{\ln2} + 1) \Big|_{1}^{\kappa - 1} = \\
%   - \frac{2^{-\kappa - 1}}{\ln2} (\kappa - 1 + \frac{1}{\ln2} + 1) + \frac{2^{-3}}{\ln2} (2 + \frac{1}{\ln2}) \sim \\
%   \frac{1}{8 \ln2} (2 + \frac{1}{\ln2})
% \end{gather*}

% We define $f = \E[X_r]$.

% We now calculate an upper bound for the expectation of $\work(A)$:

\begin{definition}[Causality]
  An execution is \emph{causal} if no block (directly or indirectly) extends
  one which is computed at a later or the same random oracle query.
\end{definition}

\begin{definition}[\poem Typical Execution]
  An execution of \poem is \emph{($\epsilon,\lambda$)-typical} (or just typical),
  for $\epsilon \in (0,1)$ and integer $\lambda > 4$, if for any set $S$ of at
  least $\lambda$ consecutive rounds, the following hold.
  \begin{itemize}
    \item $(1 - \epsilon) \E[X(S)] < X(S) < (1 + \epsilon) \E[X(S)]$ and $(1-\epsilon) \E[Y(S)] < Y(S)$.
    \item $Z(S) < (1 + \epsilon)\E[Z(S)]$.
    \item It is causal.
  \end{itemize}
\end{definition}

\begin{definition}[Block Work Interval]
  A block $B$ of chain $C$ has \emph{work interval}
  $I(B) = \{\xi \geq 0: [\xi] \lhd C = B\}$.
\end{definition}

%TODO: Define convergence opportunity & successful round

\begin{lemma}[Entropic Pairing Lemma] \label{lem:pairing}
  Suppose a block $B$ of a chain $C$ with work interval $I(B)$
  was computed by an honest party in a convergence opportunity.
  For every $\xi \in I(B)$ and every chain $C'$ of the execution,
  block $B' = [\xi] \lhd C'$ is either $B$ or adversarial,
  as long as $B' \neq \bot$.
  %TODO: Add explanation about random oracle observability
\end{lemma}
\begin{proof}
  Consider an execution as in the statement and suppose, towards a contradiction,
  that block $B'$ is not $B$ and is honestly computed.
  %TODO: Maybe define honestly computed block.
  Since $B$ was computed in a convergence opportunity, $B$ and $B'$
  cannot have been computed in the same round. Let $r$ be the earliest round
  on which $B$ or $B'$ was computed. Since it was computed by
  an honest party, at round $r + 1$, every other honest party receives
  a chain with work greater or equal to $\xi$.
  It follows that every block computed
  after round $r$ will be extending a chain with work more than $\xi$.
  If $B$ is computed after round $r$, it holds that $\xi \not \in I$.
  If $B'$ is computed after round $r$, it holds that $B' \neq [\xi] \lhd C'$.
  Both lead to a contradiction. \Qed
\end{proof}

\begin{lemma}[Entropic Chain Growth Lemma]
  Suppose that at round $r_1$ an honest party has a chain of work $w$.
  Then, by round $r_2 \geq r_1$, every honest party adopts a chain of work at least
  $w + \sum_{r = r_1}^{r_2 - 1}{X_r}$.
\end{lemma}
\begin{proof}
  By induction on $r_2$. For the inductive base ($r_2 = r_1$), observe that
  if at round $r_1$ an honest party has a chain $C$ of work $w$, then
  that party broadcasted $C$ at the end or round $r_1 - 1$. It follows that
  every honest party receives $C$ at round $r_1$ and adopts a chain with
  greater or equal work.

  For the inductive step, note that by the inductive hypothesis,
  every honest party has received a chain of work at least $w' = w + \sum_{r = r_1}^{r_2 - 2}{X_r}$
  by round $r_2 - 1$. When $X_{r_2 - 1} = 0$ the statement follows directly, so assume
  $X_{r_2 - 1} > 0$. Observe that an honest party successfully queried the random oracle
  with a chain of work at least $w' + X_{r_2 - 1}$ and broadcasted it to the network.
  At round $r_2$, every honest party receives the chain and adopts a chain
  of work at least $w' + X_{r_2 - 1} = w + \sum_{r = r_1}^{r_2 - 1}{X_r}$. \Qed
\end{proof}

\begin{lemma}[Entropic Common Prefix Lemma]
  Suppose at round $r$ of a typical execution an honest party has a chain
  $C_1$, while a chain $C_2$ of work at least $\work(C_1)$ is adopted by an honest party.
  Then, $[{:}{-w}] \lhd C_1 \preccurlyeq C_2$ and $[{:}{-w}] \lhd C_2 \preccurlyeq C_1$
  for $w = 2 \lambda f$.
\end{lemma}
\begin{proof}
    Consider an execution as in the statement and suppose,
    towards a contradiction, that $[{:}{-w}] \lhd C_1 \not \preccurlyeq C_2$
    or $[{:}{-w}] \lhd C_2 \not \preccurlyeq C_1$.
    Consider the last block $B^*$ with index $i^*$ on the common prefix of
    $C_1$ and $C_2$ that was computed by an honest party and let $r^*$
    be the round at which it was computed; if no such block exists let $r^* = 0$.
    Define the set of rounds $S = \{i: r^* < i < r\}$. We claim that
    $Z(S) \geq Y(S)$.

    We show this by pairing all work of blocks computed by honest parties during
    convergence opportunities in $S$ with adversarial work computed during $S$.
    Let $\mathcal{Y}(S)$ be the set of honestly produced blocks in convergence opportunities
    during $S$, and $\Xi = \{\xi \in I(B): B \in \mathcal{Y}(S)\}$.

    Note that $\min{\Xi} > \max{I(B^*)}$ because the chain ending in block $B^*$
    was diffused at round $r^*$, and all honestly produced blocks after round $r^*$
    are extending a chain with greater or equal work.
    Also note that $\work(C_1) \geq \max{\Xi}$ and $\work(C_2) \geq \max{\Xi}$ because
    the honest party that computed the chain with work $\max \Xi$ diffused it and any chain adopted
    by honest parties at any later round should have at least $\max \Xi$ work.
    Hence, for every $\xi \in \Xi$ it holds that
    $[\xi] \lhd C_1 \neq \bot$ and $[\xi] \lhd C_2 \neq \bot$.

    We now argue that for every $\xi \in \Xi$ either block $[\xi] \lhd C_1$
    or block $[\xi] \lhd C_2$ is adversarial. If the block lies on the
    common prefix of $C_1$ and $C_2$ ($[\xi] \lhd C_1 = [\xi] \lhd C_2$),
    then it is adversarial by the definition of $B^*$. Otherwise,
    there is one block in $C_1$ and another one in $C_2$, and by
    Lemma~\ref{lem:pairing}, it holds that $[\xi] \lhd C_1$ and
    $[\xi] \lhd C_2$ cannot both be honest.
    This completes the proof of the claim $Z(S) \geq Y(S)$.

    It holds that all chained work $\work(C_2[{i^*} {:}]) \geq w$
    was produced during $S$.
    Hence, from Lemma~\ref{lem:patience}, $|S| > \lambda$ and
    the properties of a typical execution apply.
    Therefore, by Lemma~\ref{lem:typical-bounds},
    $Z(S) < Y(S)$ which contradicts the previous claim. \Qed
\end{proof}

\atnote{Define Chained Work}


\begin{conjecture}[Entropic Patience] \label{lem:patience}
  In a typical execution, any chained work $w \geq 2 \lambda f$ is computed
  in more than $\lambda = \frac{w}{2 f}$ consecutive rounds.
\end{conjecture}

\begin{conjecture}[\poem is Safe]
  Typical executions of \poem are safe.
\end{conjecture}

\begin{conjecture}[\poem is Live]
  Typical executions of \poem are live.
\end{conjecture}

\begin{corollary}[\poem is Secure]
  Typical executions of \poem are secure.
\end{corollary}
\begin{proof}
  Security follows from safety and liveness.
  \Qed
\end{proof}

\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{figures/bounds-1.jpeg}
\end{figure}

\begin{figure}[h]
    \centering
    \includegraphics[width=1\textwidth]{figures/bounds-2.jpeg}
\end{figure}
