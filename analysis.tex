\section{Analysis}\label{sec:analysis}

To analyze the security of PoEM,
we work in the following variant of the Random Oracle model~\cite{ro}, in which
the random oracle operates as follows internally.

\begin{definition}[Real-Valued Random Oracle]
  The \emph{real-valued random oracle} $H$ can be queried with an input value $x$
  and returns the value $y[{:}{\kappa}]$ as follows.
  When queried with $x$ for the first time,
  it samples a real value $y$ uniformly at random from the continuous interval $(0, 1)$,
  and returns its first $\kappa$ bits $H(x) = y[{:}{\kappa}]$.
  It then remembers the pair $(x, y)$. We denote by $\rH(x)$ this sampled value $y$.
  When queried with $x$ for a subsequent time, it returns the first $\kappa$ bits $H(x) = y[{:}{\kappa}]$
  of the stored $y$.
\end{definition}

We note that this definition is equivalent to the standard Random Oracle model,
as the real number $y$ is unobservable by any Turing Machine, and the only
observable quantity is the $\kappa$-bit approximation $y[{:}{\kappa}]$. Despite this,
in the analysis, we will make use of the real-valued random variable $y = \rH(x)$.

\begin{definition}[Intrinsic Work]
  We define the \emph{intrinsic work} of a real number $A \in [0, 1)$ as
  $\work(A) = \gamma - \lg \frac{A[{:}{\kappa}]}{T} = \gamma - \lg \frac{\frac{\lfloor 2^\kappa A \rfloor}{2^\kappa}}{T} \in [\gamma, +\infty]$,
  where $\gamma \in \mathbb{R}^+$ is the \emph{bias} parameter of the protocol.
\end{definition}

We note that the above definition is a generalization of Definition~\ref{def:quantized-block-work}
for $A \in [0, 1)$.

\begin{definition}[Real Intrinsic Work]
  We define the \emph{real intrinsic work} of a real number $A \in [0, 1)$ as
  $\rwork(A) = \gamma - \lg \frac{A}{T} \in [\gamma, +\infty]$,
  where $\gamma \in \mathbb{R}^+$ is the \emph{bias} parameter of the protocol.
\end{definition}

To simplify the analysis, we will set bias $\gamma = 0$.
We observe that, for a block hash $H(x)$,
the actual protocol uses $\work(H(x))$, which is an approximation
of $\rwork(\rH(x))$. Because $T \in \{ 0, \frac{1}{2^\kappa}, \frac{2}{2^\kappa}, \ldots, \frac{2^\kappa - 1}{2^\kappa}\}$,
we have $\work(H(B)) \leftrightarrow \rwork(\rH(B))$.
We will use the latter value in our analysis.
Looking ahead, our goal will be to demonstrate that the small discrepancy
between these two values is immaterial to the protocol's output. The cornerstone of this
result is stated and proven in the technical \emph{Hash Separation} lemma (Lemma~\ref{lem:hash-separation})
in the appendix. The reason why this real-valued random oracle is useful is that it allows us to
borrow tools from analysis to prove statements about the protocol. In particular, the work of a block
is distributed as $\exp(\frac{1}{\ln 2})$. The sum of the works of multiple blocks in a chain has
a variance that can be bounded using Chernoff bounds that would not be available if we were to use the quantized work.

In a similar vein to the block real intrinsic work, we define the \emph{real} intrinsic work $\rwork(C)$ of a chain $C$, which
is approximated by its intrinsic work $\work(C)$:

\begin{definition}[Real Intrinsic Chain Work]
  We define the \emph{real intrinsic work} of a chain $C$ as
  $\rwork(C) = \sum_{B \in C}{\rwork(\rH(B))}$.
\end{definition}

Completely analogously to the chain addressing notation we defined in Section~\ref{sec:construction},
we define the \emph{real} chain addressing notation $[\alpha] \rlhd C$ as follows.

\noindent
\myparagraph[Real blockchain addressing]
Let $[\alpha] \rlhd C = C[i]$
where
$\rwork(C[{:}{i}]) < \alpha \leq \rwork(C[{:}{i + 1}])$.
If $\rwork(C) < \alpha$, then $[\alpha] \rlhd C = \bot$.
If $\alpha < 0$, then $[\alpha] \rlhd C = C[i]$
where
$\rwork(C[{i}{:}]) < -\alpha \leq \rwork(C[{i + 1}{:}])$.
Let $[{\alpha}{:}{\beta}] \rlhd C = C[{i}{:}{j}]$,
where $i$ is the index of $[\alpha] \rlhd C$
and $j$ is the index of $[\beta] \rlhd C$ in $C$.
Let $[{\alpha}{:}] \rlhd C = C[{i}{:}]$,
and $[{:}\beta] \rlhd C = C[{:}{j}]$,
where $i$ and $j$ are defined with respect to $\alpha$ and $\beta$
as above.

The following three chain virtues will be used as intermediate stepping stones
towards proving the security of the protocol.

\begin{definition}[Entropic Growth]
  The \emph{Entropic Growth} property of
  a \poem execution,
  parametrized by the growth interval $s \in \mathbb{N}$
  and the entropic growth velocity $\tau \in \mathbb{R}^+$,
  states that for
  all honest parties $P$ and all rounds $r_1 + s \leq r_2$,
  the chains $C_1, C_2$ of $P$ at rounds $r_1, r_2$ respectively
  satisfy $\rwork(C_2[{|C_1|}{:}]) \geq s \tau$.
\end{definition}

\begin{definition}[Existential Entropic Quality]
  The \emph{Existential Entropic Quality} property of
  a \poem execution, parametrized by the entropic \emph{quality chunk parameter} $\ell \in \mathbb{N}$,
  % and \emph{quality concentration parameter} $\mu \in \mathbb{R}^+$ (with $\ell \mu \geq 1$)
  states that for
  all honest parties $P$ and all rounds $r$,
  the chain $C$ that $P$ adopts at round $r$
  has the property that
  for every $0 \leq \alpha < \work(C) - \ell$,
  there is at least one honestly generated block in the chain
  $[{\alpha}{:}{\alpha + \ell}] \rlhd C$.
\end{definition}

\begin{definition}[Entropic Common Prefix]
  The \emph{Entropic Common Prefix} property of
  a \poem execution, parametrized by the \emph{common prefix parameter} $k \in \mathbb{N}$
  states that for
  all honest parties $P_1, P_2$
  and all rounds $r_1 \leq r_2$,
  the chains $C_1, C_2$ that $P_1, P_2$ adopt at rounds $r_1, r_2$ respectively
  satisfy $[{:}{-k}] \rlhd C_1 \preccurlyeq C_2$.
\end{definition}

% The above three properties are proven in Theorems~\ref{thm:entropic-growth},~\ref{thm:common-prefix}, and~\ref{thm:entoropic-quality}
% in the appendix. From these three properties, the safety and liveness of the protocol follow in the next two theorems,
% which are proven in the appendix.

% \begin{restatable}[\poem is Safe]{theorem}{restateSafety}\label{thm:safety}
%   Typical executions of \poem are safe.
% \end{restatable}

% \begin{restatable}[\poem is Live]{theorem}{restateLiveness}\label{thm:liveness}
%   Typical executions of \poem are live with parameter $u = \max(\ceil*{\frac{\ell + 2k}{(1 - \epsilon) f} \ln2}, s)$.
% \end{restatable}

% The security of the protocol follows from the above two theorems:

% \begin{restatable}[\poem is Secure]{corollary}{restateSecurity}\label{cor:security}
%   \poem is secure with overwhelming probability.
% \end{restatable}

In the analysis we are going to assume honest majority.

\begin{definition}[Honest Majority Assumption]
  We say that an execution has \emph{honest majority} with \emph{honest advantage parameter}
  $0 < \delta \leq 1$, if the number $t$ of corrupted parties out of
  $n$ parties satisfies $t < (1 - \delta) (n - t)$.
\end{definition}

Consider an execution of the \poem protocol.

We define a random variable $A_{r, i, j}$ as follows.
If at round $r$, the $j$-th query of (honest or adversarial) party $P_i$ is a valid block $B$ (i.e., $H(B) < T$),
then $A_{r, i, j} = \rwork(\rH(B))$.
If no valid block is found, $A_{r, i, j} = 0$.

We define $X_{r} = \max_{j=1}^q \max_{i = 1}^{n - t} A_{r, i, j}$.
If at round $r$ at least one honest party finds a valid block ($X_r > 0$),
we say that round $r$ is a \emph{successful round}.
We let $f = \Pr[X_r > 0] = 1 - (1 - T)^{q(n - t)} \geq q(n - t)T$.
Solving for $T$ we obtain
$f = 1 - (1 - T)^{q(n - t)} \Rightarrow 1 - f = (1 - T)^{q(n - t)} \Rightarrow
(1 - f)^{\frac{1}{q(n - t)}} = 1 - T \Rightarrow T = 1 - (1 - f)^{\frac{1}{q(n - t)}}$.

In our protocol parametrization, we are free to choose how quickly blocks are produced
by honest parties by adjusting the target $T$ parameter, but only some configurations
will yield the desired security results. We will set $T$ such that the following
condition is satisfied.

\begin{definition}[Secure Configuration]
  Given an environment which affords $q (n - t)$ queries per round to
  the honest parties, the secure configuration $f$ of PoEM requires
  $f = \frac{\delta}{6}$. This is achieved by using the secure target
  value $T = 1 - (1 - \frac{\delta}{6})^{\frac{1}{q(n - t)}}$.
\end{definition}

We will prove the PoEM protocol is secure if the above configuration is
followed.

We let $\overline{X}_r = \sum_{i = 1}^{n - t} \sum_{j = 1}^q A_{r,i,j}$ and
\[
  \underbar{X}_r = \begin{cases}
  0 \text{, if there are no $i, j$ with $A_{r,i,j} > 0$; otherwise,}\\
  A_{r,i,j} \text{, where $(i, j)$ are the minimum such $(i, j)$.}
\end{cases}\]
Observe that $\underbar{X}_r \leq X_r \leq \overline{X}_r$
and $\E[\underbar{X}_r] \leq \E[X_r] \leq \E[\overline{X}_r]$.

We define a random variable $Y_r$ as follows.
If at round $r$ exactly one honest party obtains a valid block, then $Y_r = X_r$,
and we call $r$ a \emph{convergence opportunity}. Otherwise, $Y_r = 0$.

We define $Z_{r}$ as the sum of all real intrinsic work generated by all adversarial
party queries during round $r$, namely $Z_{r} = \sum_{i = n - t + 1}^n \sum_{j = 1}^q A_{r, i, j}$.

Given a set of rounds $S$, we define
$X(S) = \sum_{r \in S} X_r$,
$\overline{X}(S) = \sum_{r \in S} \overline{X}_r$,
$\underbar{X}(S) = \sum_{r \in S} \underbar{X}_r$,
$Y(S) = \sum_{r \in S} Y_r$
and $Z(S) = \sum_{r \in S} Z_r$.
Observe $\underbar{X}(S) \leq X(S) \leq \overline{X}(S)$.

\begin{restatable}[Expectation Bounds]{lemma}{restateExpectationBounds}\label{lem:expectation-bounds}
  The following bounds hold.
  \begin{enumerate}
    \item $\frac{f}{1 - f} > Tq(n - t)$
    \item $\E[\underbar{X}_r] = \frac{1 - (1 - T)^{q(n - t)}}{\ln2} = \frac{f}{\ln2}
            > \frac{(1 - f)Tq(n - t)}{\ln2}$ \label{eq.ex-underbar-x-bound}
    \item $\E[\overline{X}_r] < \frac{f}{1 - f}\frac{1}{\ln2}$
    \item $\E[Y_r] > \frac{(1 - \frac{\delta}{3})f}{\ln2}$\label{eq.ex-y-bound}
    \item $\E[Z_r] = \frac{tqT}{\ln2} < \frac{t}{n - t} \cdot \frac{f}{1 - f} \cdot \frac{1}{\ln2}  < \left(1 + \frac{\delta}{2}\right)\frac{t}{n - t} \cdot \frac{f}{\ln2}$\label{eq.ex-z-bound}
    \item $\E[Z_r] < \E[X_r]$
  \end{enumerate}
\end{restatable}

Lemma~\ref{lem:expectation-bounds} is proven in appendix~\ref{app:proofs}.

% TODO: revise based on new "guess" notion in Backbone '24
\begin{definition}[Causality]
  An execution is \emph{causal} if no block (directly or indirectly) extends
  one which is computed at a later or the same random oracle query.
\end{definition}

\begin{definition}[Hash Separation] % TODO: define it the other way around as well
  An execution has Hash Separation if for all two (adversarial or honest) chains
  $C_1, C_2$ appearing in the execution, if $\rwork(C_1) < \rwork(C_2)$, then $\work(C_1) < \work(C_2)$.
\end{definition}

\begin{definition}[\poem Typical Execution]\label{def:typicality}
  An execution of \poem is \emph{($\epsilon,\lambda$)-typical} (or just typical),
  for $\epsilon \in (0,1)$ and integer $\lambda > 4$, if for any set $S$ of at
  least $\lambda$ consecutive rounds, the following hold.
  \begin{itemize}
    \item
    \begin{minipage}{\linewidth}%
      \vspace{-\abovedisplayskip}%
      \begin{align}%
        (1 - \epsilon) \E[\underbar{X}(S)] < X(S) < (1 + \epsilon) \E[\overline{X}(S)] \label{eq.typical-x}%
      \end{align}%
    \end{minipage}

    \item
    \begin{minipage}{\linewidth}%
      \vspace{-\abovedisplayskip}%
      \begin{align}%
        (1 - \epsilon) \E[Y(S)] < Y(S) \label{eq.typical-y}%
      \end{align}%
    \end{minipage}

    \item
    \begin{minipage}{\linewidth}%
      \vspace{-\abovedisplayskip}%
      \begin{align}%
        Z(S) < (1 + \epsilon)\E[Z(S)] \label{eq.typical-z}%
      \end{align}%
    \end{minipage}

    \item It is causal.
    \item It has hash separation.
  \end{itemize}
\end{definition}

In our analysis, we will let $\epsilon = \frac{\delta}{6}$. If the desired
maximum probability of failure is made concrete, this $\epsilon$, together
with the concrete probabilities later calculated in Theorem~\ref{thm:typicality},
will determine the concrete value of $\lambda$, from which the rest of the
concrete protocol parameters follow. In particular, the value $k$
for the ledger stabilization rule is
determined by $\lambda$ and $f$, and $\lambda$ can be calculated from $\epsilon$,
whereas both $f$ and $\epsilon$ can be determined from the desired acceptable
honest advantage $\delta$.

We will now prove that typical executions occur with overwhelming probability.
Towards this purpose, we will need a couple of auxiliary lemmas.

In the following arguments, we connect the \emph{real valued}
random oracle, evaluated using the $\rwork(\rH(B)) \in \mathbb{R}^+$
function (an ideal quantity
unobservable by any Turing Machine, as it cannot process real-valued
inputs), and its $\kappa$-bit \emph{discrete approximation} $\work(H(B))$ (observable by
a Turing Machine). We show the
difference between these two quantities is immaterial for polynomially bound
computations, namely they notably diverge only with negligible probability.
This connection between real-valued and discrete-valued
random variables will allow us to conduct our analysis using \emph{continuous}
random variables and, in particular, random variables distributed according to the
exponential distribution. These distributions lend themselves
to easier tools than conducting a cumbersome analysis in the discrete domain;
for instance, the sum of i.i.d. exponentially distributed variables is the gamma
distribution.
The following lemmas that translate between the continuous and discrete worlds
will allow us to later utilize our continuous results in the discrete
realization of the protocol.

First, we make a few observations about the relationship
between the real and the discrete work of blocks and chains.
Observe that for hash input $A$, we have
$H(A) \leq \rH(A)$ and for block $B$ we have
$\work(H(B)) \geq \rwork(\rH(B))$,
and for blocks $B_1, B_2$ we have
$\rwork(\rH(B_1)) \geq \rwork(\rH(B_2)) \rightarrow \work(H(B_1)) \geq \work(H(B_2))$.

Furthermore, discretizing real works preserves
the order of blocks in the following fashion.

\begin{lemma}\label{lemma:awork-rounding}
  For all $A, B \in (0, 1)$, it holds that
  $\rwork(A) \geq \rwork(B) \rightarrow \work(A) \geq \work(B)$.
\end{lemma}
\begin{proof}
  \begin{align*}
                &\rwork(A) \geq \rwork(B) \Rightarrow -\lg A \geq -\lg B \Rightarrow \lg A \leq \lg B\\
    \Rightarrow &A \leq B \Rightarrow 2^\kappa A \leq 2^\kappa B \Rightarrow \lfloor 2^\kappa A \rfloor \leq \lfloor 2^\kappa B \rfloor \Rightarrow \frac{\lfloor 2^\kappa A \rfloor}{2^\kappa} \leq \frac{\lfloor 2^\kappa B \rfloor}{2^\kappa}\\
    \Rightarrow &\lg \frac{\lfloor 2^\kappa A \rfloor}{2^\kappa} \leq \lg \frac{\lfloor 2^\kappa B \rfloor}{2^\kappa} \Rightarrow -\lg \frac{\lfloor 2^\kappa A \rfloor}{2^\kappa} \geq -\lg \frac{\lfloor 2^\kappa B \rfloor}{2^\kappa}\\
    \Rightarrow &\work(A) \geq \work(B)
  \end{align*}
  \Qed
\end{proof}

Showing that the order of \emph{chains}
is preserved under discretization is a bit more involved,
and we will work towards it next.
Towards this, we observe that the discrete work of a block is
close to its real work.

\begin{restatable}[Block Work Approximation]{lemma}{restateBlockWorkApproximation}\label{lem:block-work-approximation}
  In a PoEM execution, consider the event $\CLOSE$ that all blocks $B$
  have $\work(B) - \rwork(B) < 2^{-\kappa/2}$.
  The probability $\Pr[\CLOSE]$ is overwhelming in $\kappa$.
\end{restatable}

Lemma~\ref{lem:block-work-approximation} is proven in appendix~\ref{app:proofs}.
The discrete work of a chain is also close to the real work of a chain.

\begin{corollary}[Chain Work Approximation]\label{cor:chain-work-approximation}
  In a PoEM execution, the probability that all subchains $C^*$
  have $\work(C^*) - \rwork(C^*) < Lqn 2^{-\kappa/2}$
  is overwhelming in $\kappa$.
\end{corollary}
\begin{proof}
  Conditioned on the overwhelming event of Lemma~\ref{lem:block-work-approximation}, for all
  subchains $C^*$ it holds that
  \begin{align*}
     &\work(C^*) - \rwork(C^*) = \sum_{B \in C^*}{\work(B) - \rwork(B)}\\
    <& \sum_{B \in C^*}{2^{-\kappa/2}} = |C*| 2^{-\kappa/2} \leq Lqn 2^{-\kappa/2}\,.
  \end{align*}
  \Qed
\end{proof}

We are now ready to prove a technical lemma which shows that works
of chains do not fall dangerously close to each other.

\begin{restatable}[Good Ranges]{lemma}{restateGoodRanges}\label{lem:good-ranges}
  Consider a PoEM execution $\mathcal{E}$ with $n$ parties, $q$ queries per round per party,
  and total lifetime $L$.
  Consider the $j$-th random oracle query in this execution.
  If the query is successful, let $B$ indicate its produced block, let
  $\rw = \rwork(B), w = \work(B)$, and let $C$ be the
  chain it extends, let $\rw_1 = \rwork(C), w_1 = \work(C)$, and
  $\rw_1' = \rwork(CB), w_1' = \work(CB)$. Consider any other chain $C_i$ that appears in the
  execution, and let $\rw_2 = \rwork(C_i), w_2 = \work(C_i)$.
  Let $\BADRANGE_{j,i}$ denote the event that both
  $\rw_1 < \rw_2$, and, furthermore, either
  $\rw_2 - \frac{nqL}{2^{\kappa/2}} - \frac{1}{2^{\kappa/2}} \leq \rw_1 + \rw < \rw_2$ or
  $\rw_2 < \rw_1 + \rw \leq \rw_2 + \frac{nqL}{2^{\kappa/2}} + \frac{1}{2^{\kappa/2}}$.
  Let $\BADRANGE$ denote the event that there exists a random oracle query $j$
  and a chain $C_i$ in the execution such that $\BADRANGE_{j,i}$.
  The probability $\Pr[\BADRANGE]$ is negligible in $\kappa$.
\end{restatable}

Lemma~\ref{lem:good-ranges} is proven in appendix~\ref{app:proofs}.

\begin{restatable}[Hash Separation]{lemma}{restateHashSeparation}\label{lem:hash-separation}
  A causal execution of PoEM has Hash Separation except with negligible
  probability in $\kappa$.
\end{restatable}

Lemma~\ref{lem:hash-separation} is proven in appendix~\ref{app:proofs}.

\dznote{Handle the case of equality}

\begin{corollary}[Approximate Fork Choice]
  In Hash Separated executions of PoEM, for any two chains $C_1, C_2$
  it holds that $\work(C_1) < \work(C_2) \rightarrow \rwork(C_1) < \rwork(C_2)$.
\end{corollary}
\begin{proof}
  Suppose towards a contradiction $\work(C_1) < \work(C_2)$, but
  $\rwork(C_1) \geq \rwork(C_2)$. From Hash Separation, it follows that
  $\work(C_1) \geq \work(C_2)$, which is a contradiction.
  \Qed
\end{proof}

\begin{restatable}[Typicality]{theorem}{restateTypicality}\label{thm:typicality}
  An execution of duration $L$ of \poem is $(\epsilon, \lambda)$-typical with
  probability $1 - e^{-\Omega(\lambda - \log L)} - e^{-\Omega(\kappa - \log L)}$,
  % TODO: The correct probability is $1 - e^{-\Omega(\epsilon^2 \lambda f - \log L)} - e^{-\Omega(\kappa - \log L)}$
  namely, overwhelming in $\lambda$ and $\kappa$.
\end{restatable}

Theorem~\ref{thm:typicality} is proven in appendix~\ref{app:proofs}.

\begin{definition}[Block Work Interval]
  A block $B$ of chain $C$ has \emph{work interval}
  $I(B) = \{\xi \geq 0: [\xi] \rlhd C = B\}$.
\end{definition}

\begin{restatable}[Entropic Pairing Lemma]{lemma}{restatePairing}\label{lem:pairing}
  Consider a typical execution of PoEM.
  Suppose a block $B$ of a chain $C$ with work interval $I(B)$
  was computed by an honest party in a convergence opportunity.
  For every $\xi \in I(B)$ and every chain $C'$ of the execution,
  block $B' = [\xi] \lhd C'$ is either $B$ or adversarial,
  as long as $B' \neq \bot$.
\end{restatable}

Lemma~\ref{lem:pairing} is proven in appendix~\ref{app:proofs}.

% The following conjecture is likely true and will allow us to tighten the analysis:
%
% \begin{conjecture}[Entropic Pairing Conjecture]
%   Consider any block $B$ of chain $C$ with work interval $I(B)$
%   computed by an honest party during a round $r$ such that
%   for every $B'$ which was honestly computed during round $r$,
%   it holds that $\work(B) \geq \work(B')$.
%   Then, for every $\xi \in I(B) \setminus I(B')$ and every chain $C'$ of the execution,
%   block $B' = [\xi] \lhd C'$ is either $B$ or adversarial,
%   as long as $B' \neq \bot$.
% \end{conjecture}

\begin{restatable}[Entropic Chain Growth Lemma]{lemma}{restateChainGrowth}\label{lem:chain-growth}
  Suppose that at round $r_1$ an honest party $P_1$ has a chain which has real work $\rw$.
  Then, at round $r_2 \geq r_1$, every honest party $P_2$
  adopts a chain which has real work at least
  $\rw + \sum_{r = r_1}^{r_2 - 1}{X_r}$.
\end{restatable}

Lemma~\ref{lem:chain-growth} is proven in appendix~\ref{app:proofs}.

\begin{restatable}[Typical Bounds]{lemma}{restateTypicalBounds}\label{lem:typical-bounds}
  In typical PoEM executions, for any set $S$ of at least $\lambda$ consecutive rounds,
  it holds that:

  \begin{enumerate}
    \item $Z(S) < \frac{t}{n - t} \cdot \frac{f}{1 - f} \cdot \frac{|S|}{\ln2} + \epsilon f \frac{|S|}{\ln2} \leq (1 - \frac{2 \delta}{3}) f \frac{|S|}{\ln2}$. \label{eq.typ-bound-z}
    \item $Z(S) < \left(1 + \frac{\delta}{2}\right)\frac{t}{n - t} X(S) + \frac{\epsilon f |S|}{\ln2}$. \label{eq.typ-bound-z-x}
    \item $Z(S) < Y(S)$. \label{eq.typ-bound-y-z}
  \end{enumerate}
\end{restatable}

Lemma~\ref{lem:typical-bounds} is proven in appendix~\ref{app:proofs}.
% \atnote{Define Chained Work}

\begin{restatable}[Entropic Growth]{theorem}{restateEntropicGrowth}\label{thm:entropic-growth}
  Typical executions of \poem satisfy the Entropic Growth property
  with $s = \lambda$ and $\tau = (1 - \epsilon)\frac{f}{\ln2}$.
\end{restatable}

Theorem~\ref{thm:entropic-growth} is proven in appendix~\ref{app:proofs}.

\begin{restatable}[Entropic Patience]{lemma}{restatePatience}\label{lem:patience}
  In a typical execution, any chained real work $k \geq 2 \lambda \frac{f}{1 - f} \frac{1}{\ln2} + 8$ is computed
  in more than $\frac{k - 8}{2 \frac{f}{1 - f} \frac{1}{\ln2}} \geq \lambda$ consecutive rounds.
\end{restatable}

Lemma~\ref{lem:patience} is proven in appendix~\ref{app:proofs}.

\begin{corollary} \label{cor:slicing-work-bound}
  In a typical execution of \poem, for any honest party $P$ and any round $r$ it holds that
  $\rwork([{:}{-k}] \rlhd \Chain[P][][r]) < 2k$.
\end{corollary}
\begin{proof}
  From Entropic Patience (Lemma~\ref{lem:patience}), every block has less than $k$ real work. Therefore,
  $\rwork([-k] \rlhd \Chain[P][][r]) < k$.
  From the definition of the slicing notation ($[{:}]\rlhd$)
  it holds that $\rwork(([-k{:}] \rlhd \Chain[P][][r])[1{:}]) \leq k$. Summing the two constituents,
  we obtain
  \begin{align*}
    \rwork([-k{:}] \rlhd \Chain[P][][r]) =\\
    \rwork(([-k{:}] \rlhd \Chain[P][][r])[1{:}]) + \rwork([-k] \rlhd \Chain[P][][r]) < 2k\,.
  \end{align*}
  \Qed
\end{proof}

\begin{lemma}[Entropic Common Prefix Lemma] \label{lem:common-prefix-lemma}
  For all rounds $r$, and all honest parties $P_1, P_2$, where $P_1$ has $C_1$ and $P_2$ adopts $C_2$ at round $r$
  of a typical PoEM execution, it holds that $[{:}{-k}] \rlhd C_1 \preccurlyeq C_2$ and $[{:}{-k}] \rlhd C_2 \preccurlyeq C_1$
  for $k = 2 \lambda \frac{f}{1 - f} \frac{1}{\ln2} + 8$.
\end{lemma}
\begin{proof}
  Consider an execution as in the statement and suppose,
  towards a contradiction, that $[{:}{-k}] \rlhd C_1 \not \preccurlyeq C_2$
  or $[{:}{-k}] \rlhd C_2 \not \preccurlyeq C_1$.
  Consider the last block $B^*$ with index $i^*$ on the common prefix of
  $C_1$ and $C_2$ that was computed by an honest party and let $r^*$
  be the round at which it was computed; if no such block exists let $r^* = 0$.
  Define the set of rounds $S = \{i: r^* < i < r\}$. We claim that
  $Z(S) \geq Y(S)$.

  We show this by pairing all real work of blocks computed by honest parties during
  convergence opportunities in $S$ with adversarial real work computed during $S$.
  Let $\mathcal{Y}(S)$ be the set of honestly produced blocks in convergence opportunities
  during $S$, and $\Xi = \bigcup \{I(B): B \in \mathcal{Y}(S)\}$.

  Note that, if $\Xi \neq \emptyset$, then $\inf{\Xi} \geq \max{I(B^*)}$
  because the chain ending in block $B^*$
  was diffused at round $r^*$, and all honestly produced blocks after round $r^*$
  are extending a chain with greater or equal real work.
  Also note that $\rwork(C_1) \geq \max{\Xi}$ and $\rwork(C_2) \geq \max{\Xi}$ because
  the honest party that computed the chain with work $\max \Xi$ diffused it and any chain adopted
  by honest parties at any later round should have at least $\max \Xi$ work. % TODO: this is real work, but parties are adopting based on approximate work. Need to use Hash Separation.
  \atnote{Why is $\work(C_1) \geq \max \Xi$?}
  \dznote{I believe this was a mistake in Backbone.}
  Hence, for every $\xi \in \Xi$ it holds that
  $[\xi] \rlhd C_1 \neq \bot$ and $[\xi] \rlhd C_2 \neq \bot$.

  We now argue that for every $\xi \in \Xi$ either block $[\xi] \rlhd C_1$
  or block $[\xi] \rlhd C_2$ is adversarial. If the block lies on the
  common prefix of $C_1$ and $C_2$, namely $[\xi] \rlhd C_1 = [\xi] \rlhd C_2$,
  then it is adversarial by the definition of $B^*$. Otherwise,
  there is one block in $C_1$ and another one in $C_2$, and by
  Lemma~\ref{lem:pairing}, it holds that $[\xi] \rlhd C_1$ and
  $[\xi] \rlhd C_2$ cannot both be honest.
  This completes the proof of the claim $Z(S) \geq Y(S)$.

  All the chained real work $\max(\rwork(C_1[{i^*} {:}]), \rwork(C_2[{i^*} {:}])) \geq k$
  was produced during $S \cup \{r^*\}$.
  Hence, from Lemma~\ref{lem:patience}, $|S \cup \{r^*\}| > \lambda \Rightarrow |S| \geq \lambda$ and
  the properties of a typical execution apply.
  Therefore, by Lemma~\ref{lem:typical-bounds},
  $Z(S) < Y(S)$ which contradicts the previous claim. \Qed
\end{proof}

\begin{theorem}[Entropic Common Prefix] \label{thm:common-prefix}
  Typical executions of \poem satisfy Entropic Common Prefix
  with $k = 2 \lambda \frac{f}{1 - f} \frac{1}{\ln2} + 8$.
\end{theorem}
\begin{proof}
  Consider a typical execution and suppose, towards a contradiction, that Common
  Prefix is violated, and let $r_2$ be the first round during which it is violated.
  At $r_2$ there is an honest party $P_2$ who adopts chain $C_2$
  inconsistent with the chain $C_1$ adopted by an honest party
  $P_1$ at a round $r_1 \leq r_2$, namely $[{:}{-k}] \rlhd C_1 \not\preceq C_2$.

  % TODO: Change algorithm so that has r => adopts r + 1
  \noindent
  \textbf{Case $r_1 < r_2$.}
  At round $r_2$, party $P_1$ has a chain $C$,
  which it adopted at $r_2 - 1$ (not excluding the case
  where $C = C_1$). It holds that $[{:}{-k}] \rlhd C_1 \preceq C$
  due to the minimality of $r_2$ (otherwise, the Common Prefix virtue would
  have been broken at $r_2 - 1$ by chains $C_1$ and $C$).
  Furthermore, $\rwork(C) \geq \rwork(C_1)$ due to the heaviest chain
  rule followed by $P_1$. % TODO: Hash Separation needed for this part?
  Therefore, $[{:}{-k}] \rlhd C_1 \preceq [{:}{-k}] \rlhd C$.
  By the Common Prefix lemma, we have $[{:}{-k}] \rlhd C \preceq C_2$
  (at $r_2$, party $P_1$ has $C$ and party $P_2$ adopts $C_2$).
  By transitivity of $\preceq$, we have $[{:}{-k}] \rlhd C_1 \preceq C_2$,
  which contradicts the violation of Common Prefix.

  \noindent
  \textbf{Case $r_1 = r_2$.}
  Let $C$ be the chain that $P_1$ adopts at $r_1 + 1$ (not excluding the case
  where $C = C_1$).
  By the Common Prefix lemma, we have that
  $[{:}{-k}] \rlhd C_1 \preceq C$ (at $r_1 + 1$, party $P_1$ adopts $C$ and has $C_1$).
  Furthermore, $\rwork(C) \geq \rwork(C_1)$ due to the heaviest chain
  rule followed by $P_1$. % TODO: Hash Separation is needed here too?
  Because $\rwork(C) \geq \rwork(C_1)$, therefore $[{:}{-k}] \rlhd C_1 \preceq [{:}{-k}] \rlhd C$.
  By the Common Prefix lemma, we have that
  $[{:}{-k}] \rlhd C \preceq C_2$ (at $r_1 + 1$, party $P_1$ adopts $C$ and party $P_2$ has $C_2$).
  By transitivity of $\preceq$, we have $[{:}{-k}] \rlhd C_1 \preceq C_2$,
  which contradicts the violation of Common Prefix.
  \Qed
\end{proof}

\begin{theorem}[Entropic Quality] \label{thm:entoropic-quality}
  Typical executions of \poem satisfy the Entropic Quality property
  with $\ell = 2 \lambda \frac{f}{1 - f} \frac{1}{\ln2} + 8$ and
  $\mu = 1 - (1 + \frac{\delta}{2})\frac{t}{n - t} - \frac{\epsilon}{1 - \epsilon}$.
\end{theorem}
\begin{proof}
  Suppose, towards a contradiction, that there is a chain quality violation in a typical
  \poem execution. Then there is an honest party $P$ who adopts a chain $C_3$
  at round $r$ for which chain quality is violated.
  This means there are $u, v$ such that the chain $C_1 = C_3[u{:}v]$
  has $\rwork(C_1) \geq \ell$ and quality lower than $\mu$, namely
  the sum $x$ of works of all honestly generated blocks in $C_1$ is less than
  $\mu \rwork(C_1)$.
  Consider the minimum real work chain $C_2 = C_3[{u'}{:}{v'}]$
  such that $C_1$ is fully included in $C_2$ (i.e., $u' \leq u$ and $v' \geq v$)
  with the following properties:

  \begin{enumerate}
    \item $C_3[u']$ was computed by an honest party $P_1$ (this will exist because $C_3[0]$ is the genesis block, which is honestly generated) at some round $r_1$ (letting $r_1 = 0$ if $u' = 0$).
    \item $C_3[v']$ was the tip of the adopted chain by an honest party $P_2$ at some round $r_2$ (this will exist because $P$ adopts $C_3$).
  \end{enumerate}

  Let $L = \rwork(C_2)$ and $S = \{r_1, \ldots, r_2 - 1\}$. Note that, by causality,
  all the work $L$ was computed in $S$. By the supposition, we have
  $x < \mu \ell \leq \mu L$.

  We have that $Z(S) \geq L - x$. To see this, observe that, by the minimality of $C_2$, all the blocks
  with heights $u', \ldots, u$ as well as the blocks with heights $v, \ldots, v'$ were computed by the adversary, and so the only honest real work computed within $L$ is $x$.

  Additionally, $L \geq X(S)$. To see this, note that at round $r_1$, party $P_1$ produced $C_3[u']$,
  and so every honest party adopts a chain of real work at least $\rwork(C_3[{u'}{:}])$ from round $r_1 + 1$
  onwards. % TODO: Hash Separation is needed to make this argument
  Therefore, by Lemma~\ref{lem:chain-growth}, at round $r_2$, every honest party adopts a chain of real work at least $\rwork(C_3[{u'}{:}]) + X(S)$. But we know that $P_2$ adopts a chain
  of real work $\rwork(C_3[{u'}{:}]) + L$, and so $L \geq X(S)$.

  Therefore,
  \begin{align*}
    Z(S) \geq L - x > (1 - \mu)L \geq (1 - \mu)X(S)\\
    \geq ((1 + \frac{\delta}{2})\cdot\frac{t}{n - t} + \frac{\epsilon}{1 - \epsilon})X(S)\,.
  \end{align*}

  The last inequality follows from replacing the value of $\mu$ from the statement.
  By Lemma~\ref{lem:patience}, $|S| > \lambda$ and typical bounds apply. Therefore,
  $X(S) > (1 - \epsilon)\E[\underline{X}(S)] = (1 - \epsilon)\frac{f}{\ln2}$ and,
  from this and the previous inequality,
  $Z(S) \geq (1 + \frac{\delta}{2})\cdot\frac{t}{n - t}X(S) + \epsilon f \frac{|S|}{\ln2}$.
  However, this contradicts the bound in Lemma~\ref{lem:typical-bounds}.
  \Qed
\end{proof}

\begin{lemma}[Confirmation Separation] \label{lem:confirmation-separation}
  For any function $k = k(\kappa)$, it holds that, in a PoEM execution,
  $\Pr[\exists C: [{:}{-k}] \rlhd C \neq [{:}{-k}] \lhd C]$
  is negligible in $\kappa$.
\end{lemma}
\begin{proof}
  Consider the event that there exists a \emph{chain} $C$ with
  $[{:}{-k}] \rlhd C \neq [{:}{-k}] \lhd C$. Since the prefixes
  differ, the suffixes must also differ, namely
  $[{-k}{:}] \rlhd C \neq [{-k}{:}] \lhd C$.
  Let $C^* = [{-k}{:}] \lhd C$.
  By the slicing notation, it directly follows that $\work(C^*) \geq k$.
  Additionally, we observe that $k > \rwork(C^*)$
  (otherwise, $[{-k}{:}] \rlhd C = [{-k}{:}] \lhd C$).
  % TODO: Add figure
  Define $\borderline$ the bad event that there exists some subchain $C^*$
  in the execution such that $\work(C^*) \geq k > \rwork(C^*)$.
  We have shown that $\exists C: [{:}{-k}] \rlhd C \neq [{:}{-k}] \lhd C \rightarrow \borderline$.

  It suffices to show that $\Pr[\borderline]$ is negligible.

  Let $E_1$ be the event that there exists a subchain $C^*$ such that
  $\work(C^*) - \rwork(C^*) \geq Lqn2^{-\kappa/2}$, and let $p_1 = \Pr[E_1]$.
  Let $E_2$ be the event that there exists a subchain $C^*$ such that
  $k - Lqn2^{\kappa/2} \leq \rwork(C^*) < k$, and let $p_2 = \Pr[E_2]$.
  We observe that $\lnot E_1 \land \lnot E_2 \rightarrow \lnot \borderline$,
  hence $\borderline \rightarrow E_1 \lor E_2$.
  Therefore, from the union bound, we have
  \[
  \Pr[E_1] + \Pr[E_2] = p_1 + p_2 \geq \Pr[E_1 \lor E_2] \geq \Pr[\borderline]
  \]\~.

  From Corollary~\ref{cor:chain-work-approximation}, we have that
  $p_1$ is negligible.

  Let us calculate the probability $p_2$. Consider all the, at most $(nqL)^2$, subchains
  $C^*_1, C^*_2, \ldots, C^*_{(nqL)^2}$ appearing in an execution, and consider an aribtrary
  subchain $C^*_i$ among them. Because the work of each
  block $B$ in $C^*_i$ is distributed as $\Exp(\ln2)$,
  the points $(\rwork(C^*_i[{:}{1}]), \rwork(C^*_i[{:}{2}]), \ldots, \rwork(C^*_i))$
  correspond to the initial $\rwork(C^*_i)$ segment of a Poisson stochastic
  process with rate $\ln2$ (do not
  confuse the \emph{work} between blocks, which exactly follows a Poisson process with rate $\ln2$,
  and the \emph{time} between consecutive block generation).
  We are interested in the number of Poisson points that fall within the interval
  $[k - Lqn2^{-\kappa/2}, k)$. This is a random variable distributed as a Poisson
  distribution with rate $Lqn2^{-\kappa/2} \lambda$. Let $F_i$ be the bad event that
  the number of points of the process corresponding to the subchain $C^*_i$ that fall
  within the interval $[k - Lqn2^{-\kappa/2}, k)$ is at least one.
  Using the probability mass function of the Poisson distribution evaluated at $0$
  we have $\Pr[F_i] = 1 - \Pr[\lnot F_i] = 1 - e^{-\lambda Lqn2^{-\kappa/2}}
  = 1 - 2^{-(\lg e) \lambda Lqn2^{-\kappa/2}} < (\lg e) \lambda Lqn2^{-\kappa/2}$,
  where the last inequality follows from Lemma~\ref{lem:bernoulli}.
  Taking a union bound over all subchains, we have
  $p_2 = \Pr[E_2] = \Pr[\bigcup_{i=1}^{(nqL)^2}F_i] \leq \sum_{i = 1}^{(nqL)^2}\Pr[F_i] = (nqL)^2 \Pr[F_i] < (nqL)^3 (\lg e) \lambda 2^{-\kappa/2}$
  which is negligible. Therefore, $\Pr[\borderline]$ is negligible.
  \Qed
\end{proof}


% \restateSafety*
\begin{theorem}[\poem is Safe]\label{thm:safety}
  Typical executions of \poem are safe.
\end{theorem}
\begin{proof}
  Consider any two honest parties $P_1, P_2$ and
  any rounds $r_1, r_2$. Let $C_1, C_2$ be the chains that $P_1, P_2$
  adopt at rounds $r_1, r_2$ respectively.
  From Entropic Common Prefix (Theorem~\ref{thm:common-prefix}), it follows that
  if $r_1 \leq r_2$, then $[{:}{-k}] \rlhd C_1 \preccurlyeq C_2$; and
  if $r_2 \leq r_1$, then $[{:}{-k}] \rlhd C_2 \preccurlyeq C_1$.
  In both cases, it follows that $[{:}{-k}] \rlhd C_1 \sim [{:}{-k}] \rlhd C_2$.
  From Confirmation Separation (Lemma~\ref{lem:confirmation-separation}),
  it follows that $[{:}{-k}] \lhd C_1 \sim [{:}{-k}] \lhd C_2$.
  Therefore, for the ledgers $\Ledger[P_1][][r_1], \Ledger[P_2][][r_2]$ returned when
  \lread is invoked on parties $P_1, P_2$ after rounds $r_1, r_2$ respectively,
  % TODO: \lread uses \lhd, not \rlhd; a Hash Separation is needed
  it holds that $\Ledger[P_1][][r_1] \sim \Ledger[P_2][][r_2]$.
\end{proof}

% \restateLiveness*
\begin{theorem}[\poem is Live]\label{thm:liveness}
  Typical executions of \poem are live with parameter $u = \max(\ceil*{\frac{\ell + 2k}{(1 - \epsilon) f} \ln2}, s)$.
\end{theorem}
\begin{proof}
  Consider any round $r$.
  Because $u \geq s$, invoking Entropic Growth($s, \tau$) (Theorem~\ref{thm:entropic-growth}), we conclude that
  for all honest parties $P$ and all rounds $r' \geq r + u$, it holds that
  $\rwork(\Chain[P][][r'][|\Chain[P][][r]|{:}]) \geq u \tau \geq \ell + 2k$.
  From Corollary~\ref{cor:slicing-work-bound}, it follows that
  $\rwork([{:}{-k}] \rlhd \Chain[P][][r'][|\Chain[P][][r]|{:}]) \geq \ell$.
  Invoking Entropic Quality (Theorem~\ref{thm:entoropic-quality}),
  it holds that in the chain segment $[{:}{-k}] \rlhd \Chain[P][][r'][|\Chain[P][][r]|{:}]$,
  there is at least one honestly generated block that was produced after round $r$.

  Now, consider that an honest party attempts to inject a transaction \tx
  at round $r$. At the beginning of round $r + 1$, all honest parties
  receive \tx and include it in their mempool~\cite[Section 5.7]{blockchain-foundations}.
  Hence, all honest blocks produced
  after round $r$ will either include, or extend a chain that includes transaction \tx.
  Because of this and the above, for all honest parties $P$ and rounds $r' \geq r + u$,
  we conclude that $\tx \in \Ledger[P][][r']$.
  \Qed
\end{proof}

% \restateSecurity*
\begin{theorem}[\poem is Secure]\label{cor:security}
  \poem is secure with overwhelming probability.
\end{theorem}
\begin{proof}
  Executions are typical with overwhelming probability (Theorem~\ref{thm:typicality}).
  Typical executions are safe (Theorem~\ref{thm:safety}), and live (Theorem~\ref{thm:liveness}), from which
  security follows.
  \Qed
\end{proof}